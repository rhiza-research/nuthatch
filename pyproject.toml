[project]
name = "nuthatch"
dynamic = ["version"]
description = "Cacheable big data pipelines"
authors = [
    { name = "Joshua Adkins", email = "josh@rhizaresearch.org" },
    { name = "Genevieve Flaspohler", email = "geneviee@rhizaresearch.org" }
]
readme = "README.md"
requires-python = ">= 3.10"
license = {text = "MIT"}

# TODO: Make backend submodules so that their
# dependencies can be installed independently
dependencies = [
    "fsspec",
    "sqlalchemy",
    "pandas",
    "dask[dataframe]",
    "deltalake==1.1.2",
    "dask-deltatable",
    "xarray",
    "pyarrow",
    "terracotta",
    "gitpython",
    "psycopg2",
    "zarr",
    "click",
    "polars"
]

[project.scripts]
nuthatch = "nuthatch.cli:main"

[build-system]
requires = ["hatchling==1.26.3", "hatch-vcs"]
build-backend = "hatchling.build"

[tool.uv]
managed = true
dev-dependencies = [
    "pooch",
    "google-cloud-secret-manager",
    "gcsfs",
    "pytest>=7.0.0",
    "pytest-cov>=4.0.0",
    "pytest-mock>=3.10.0",
    "ruff>=0.1.0",
    "sheerwater-benchmarking @ git+https://github.com/rhiza-research/sheerwater-benchmarking",
]

[tool.hatch.metadata]
allow-direct-references = true

[tool.hatch.version]
 source = "vcs"

[tool.hatch.build.targets.wheel]
packages = ["src/nuthatch"]
exclude = [
    "src/nuthatch/test_secrets.py" # Exclude a specific file
]

[tool.pytest.ini_options]
log_cli = true
log_cli_level = "DEBUG"
log_cli_format = "%(asctime)s.%(msecs)03d %(levelname)s %(filename)s:%(lineno)s %(message)s"
addopts = [
    "--strict-markers",
    "--cov=nuthatch",
    "--cov-report=term-missing",
    "--cov-report=html",
    "--cov-report=xml",
]

[tool.coverage.run]
source = ["src/nuthatch"]
omit = ["*/tests/*", "*/__pycache__/*"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "if __name__ == .__main__.:",
    "raise AssertionError",
    "raise NotImplementedError",
]


[tool.nuthatch]
filesystem = "gs://sheerwater-datalake/caches"
host = "postgres.sheerwater.rhizaresearch.org"
port = 5432
database = "postgres"
username = "write"
driver = "postgresql"
raster_store = "gs://terracotta-files"
metadata_location = "filesystem"
dynamic_config_path = "nuthatch.test_secrets"

[tool.nuthatch.filesystem_options]
token = "google_default"
cache_timeout = 0

[tool.nuthatch.local]
filesystem = "~/.cache/nuthatch"
